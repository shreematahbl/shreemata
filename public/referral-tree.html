<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Referral Tree</title>

<style>
body {
    background: #f8f9fa;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    min-height: 100vh;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.tree-card {
    background: white;
    padding: 35px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-top: 30px;
    border: 1px solid #e0e0e0;
}

.tree-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e0e0e0;
}

.tree-header h2 {
    color: #1a1a1a;
    font-size: 24px;
    font-weight: 600;
    letter-spacing: -0.5px;
}

.tree-controls {
    display: flex;
    gap: 10px;
}

.tree-search {
    padding: 9px 14px;
    border-radius: 6px;
    border: 1px solid #d0d0d0;
    width: 240px;
    transition: all 0.2s;
    font-size: 14px;
}

.tree-search:focus {
    outline: none;
    border-color: #4a90e2;
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

.btn-primary, .btn-secondary {
    padding: 9px 18px;
    border: 1px solid #d0d0d0;
    background: white;
    color: #333;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    font-size: 14px;
}

.btn-primary:hover {
    background: #f8f9fa;
    border-color: #4a90e2;
    color: #4a90e2;
}

.btn-secondary {
    background: #4a90e2;
    color: white;
    border-color: #4a90e2;
}

.btn-secondary:hover {
    background: #357abd;
    border-color: #357abd;
}

.tree-node {
    background: #ffffff;
    border: 1px solid #d0d0d0;
    padding: 10px 16px;
    border-radius: 6px;
    min-width: 130px;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    position: relative;
    transition: all 0.2s;
}

.tree-node:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    border-color: #4a90e2;
}

.tree-name {
    font-weight: 600;
    font-size: 13px;
    color: #1a1a1a;
    margin-bottom: 3px;
    letter-spacing: -0.2px;
}

.tree-meta {
    font-size: 11px;
    color: #666;
    font-weight: 400;
}

.tree-level {
    position: relative;
    padding-top: 20px;
}

.tree-level::before {
    content: "";
    position: absolute;
    top: 0;
    left: 50%;
    width: 1px;
    height: 20px;
    background: #c0c0c0;
    transform: translateX(-50%);
}

/* Hide for root */
.tree-level:first-child::before {
    display: none;
}

.tree-children {
    display: flex;
    gap: 25px;
    justify-content: center;
    margin-top: 20px;
    position: relative;
}

.tree-children::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: #c0c0c0;
}

/* Each child vertical line */
.tree-children > div {
    position: relative;
}

.tree-children > div::before {
    content: "";
    position: absolute;
    top: -20px;
    left: 50%;
    width: 1px;
    height: 20px;
    background: #c0c0c0;
    transform: translateX(-50%);
}

</style>

</head>
<body>

<div class="container">

    <div class="tree-card">

        <div class="tree-header">
            <h2 style="color:#131921;">Referral Tree</h2>

            <div class="tree-controls">
                <input id="searchInput" class="tree-search" placeholder="Search user...">
                <button id="refreshBtn" class="btn-primary">Refresh</button>
                <button id="exportBtn" class="btn-secondary">Export PNG</button>
            </div>
        </div>

        <p style="color:#666; margin-bottom:10px;">
            View your full referral network (unlimited levels).
        </p>

        <div id="treeWrap"></div>

        <div id="loading" style="padding:20px; text-align:center; color:#666;">
            Loading referral tree…
        </div>

    </div>

</div>

<script>
const API = (typeof API_URL !== 'undefined') ? API_URL : '';

document.getElementById('refreshBtn').addEventListener('click', loadTree);
document.getElementById('exportBtn').addEventListener('click', () => window.print());

async function loadTree(){
    const wrap = document.getElementById('treeWrap');
    const loading = document.getElementById('loading');
    wrap.innerHTML = '';
    loading.style.display = 'block';

    try{
        const token = localStorage.getItem('token');
        if(!token) return window.location.href="/login.html";

        const res = await fetch(API + "/api/referral/tree", {
            headers: { "Authorization": "Bearer " + token }
        });

        const data = await res.json();

        loading.style.display = 'none';

        if (!data || !data.root){
            wrap.innerHTML = "<p>No referral records found.</p>";
            return;
        }

        const tree = buildTree(data.root, data.children);
        wrap.appendChild(tree);

    }catch(err){
        console.error(err);
        loading.innerHTML = "Error loading tree.";
    }
}

function buildTree(root, children){
    const container = document.createElement("div");
    container.className = "tree-level";

    container.appendChild(createUserNode(root));

    if(!children || children.length === 0) return container;

    const childWrap = document.createElement("div");
    childWrap.className = "tree-children";

    children.forEach(c => {
        childWrap.appendChild(
            buildTree(c, c.children || [])
        );
    });

    container.appendChild(childWrap);
    return container;
}

function createUserNode(user){
    const node = document.createElement("div");
    node.className = "tree-node";

    node.innerHTML = `
        <div class="tree-name">${escapeHtml(user.name)}</div>
        
        <div class="tree-meta">Wallet: ₹${Number(user.wallet||0).toFixed(2)}</div>
        <div class="tree-meta">${user.referrals||0} referrals</div>
    `;
    return node;
}

function escapeHtml(s){
    return String(s).replace(/[&<>\"']/g, c => (
        { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]
    ));
}

loadTree();
</script>

</body>
</html>
