<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commission Settings - BookStore Admin</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body { background: #f5f5f5; margin: 0; padding: 0; }
        nav { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
        nav .container { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        nav h1 { color: white; margin: 0; font-size: 24px; }
        nav div { display: flex; gap: 15px; align-items: center; }
        nav a { color: white; text-decoration: none; padding: 8px 16px; border-radius: 6px; transition: all 0.3s ease; font-weight: 500; }
        nav a:hover, nav a.active { background: rgba(255,255,255,0.2); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .main-container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 100px; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .setting-card { background: #f9f9f9; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0; }
        .setting-card h3 { margin: 0 0 15px 0; color: #333; font-size: 16px; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }
        .form-group input { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-success { background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); }
        .alert { padding: 15px; border-radius: 8px; margin: 15px 0; }
        .alert-success { background: #e8f5e9; color: #2e7d32; border-left: 4px solid #2e7d32; }
        .alert-error { background: #ffebee; color: #c62828; border-left: 4px solid #c62828; }
        .level-inputs { display: flex; flex-direction: column; gap: 10px; }
        .level-input { display: flex; align-items: center; gap: 10px; }
        .level-input input { flex: 1; }
        footer { background: #333; color: white; text-align: center; padding: 20px 0; margin-top: 60px; }
    </style>
</head>
<body>
    <nav>
        <div class="container">
            <h1>üìö BookStore Admin</h1>
            <div>
                <span id="userName" style="color: white; margin-right: 10px;"></span>
                <a href="/">üè† Home</a>
                <a href="/admin.html">Books</a>
                <a href="/admin-bundles.html">Bundles</a>
                <a href="/admin-orders.html">Orders</a>
                <a href="/admin-withdrawals.html">Withdrawals</a>
                <a href="/admin-notifications.html">Notifications</a>
                <a href="/admin-income.html">Income</a>
                <a href="/admin-users.html">Users</a>
                <a href="/admin-commission-settings.html" class="active">Settings</a>
                <a href="/admin-referral-tree.html">Referral Tree</a>
                <a href="/" id="logoutBtn">Logout</a>
            </div>
        </div>
    </nav>

    <main>
        <div class="container">
            <div class="main-container">
                <div style="margin-bottom: 30px;">
                    <h1 style="margin: 0 0 5px 0;">‚öôÔ∏è Commission Settings</h1>
                    <p style="color: #666; margin: 0;">Configure commission percentages for the referral system</p>
                </div>

                <div id="alertContainer"></div>

                <div class="settings-grid">
                    <div class="setting-card">
                        <h3>üí∞ Direct Commission</h3>
                        <div class="form-group">
                            <label>Percentage (%)</label>
                            <input type="number" id="directCommission" step="0.01" min="0" max="100">
                            <small style="color: #666;">Commission paid to direct referrer</small>
                        </div>
                    </div>

                    <div class="setting-card">
                        <h3>üè¶ Trust Fund</h3>
                        <div class="form-group">
                            <label>Percentage (%)</label>
                            <input type="number" id="trustFund" step="0.01" min="0" max="100">
                            <small style="color: #666;">Allocated to Trust Fund</small>
                        </div>
                    </div>

                    <div class="setting-card">
                        <h3>üöÄ Development Fund</h3>
                        <div class="form-group">
                            <label>Percentage (%)</label>
                            <input type="number" id="devFund" step="0.01" min="0" max="100">
                            <small style="color: #666;">Allocated to Development Fund</small>
                        </div>
                    </div>

                    <div class="setting-card">
                        <h3>üå≥ Tree Commission Pool</h3>
                        <div class="form-group">
                            <label>Total Pool (%)</label>
                            <input type="number" id="treePool" step="0.01" min="0" max="100">
                            <small style="color: #666;">Total for tree distribution</small>
                        </div>
                    </div>
                </div>

                <div class="setting-card" style="margin: 20px 0;">
                    <h3>üìä Tree Commission Levels</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Configure percentage for each tree level</p>
                    <div id="treeLevels" class="level-inputs"></div>
                    <button class="btn" onclick="addLevel()" style="margin-top: 10px;">+ Add Level</button>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button class="btn btn-success" onclick="saveSettings()">üíæ Save Settings</button>
                    <button class="btn btn-secondary" onclick="resetSettings()">üîÑ Reset to Defaults</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 BookStore. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/config.js"></script>
    <script>
        const token = localStorage.getItem("token");
        if (!token) window.location.href = "/login.html";

        const userName = localStorage.getItem("userName");
        if (userName) document.getElementById("userName").textContent = `Hello, ${userName}`;

        document.getElementById("logoutBtn").addEventListener("click", (e) => {
            e.preventDefault();
            localStorage.removeItem("token");
            localStorage.removeItem("userName");
            localStorage.removeItem("userRole");
            window.location.href = "/login.html";
        });

        let currentSettings = null;

        async function loadSettings() {
            try {
                const response = await fetch(`${API_URL}/admin/commission-settings`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (!response.ok) throw new Error("Failed to load settings");

                const data = await response.json();
                currentSettings = data.settings;

                document.getElementById("directCommission").value = currentSettings.directCommissionPercent;
                document.getElementById("trustFund").value = currentSettings.trustFundPercent;
                document.getElementById("devFund").value = currentSettings.developmentFundPercent;
                document.getElementById("treePool").value = currentSettings.treeCommissionPoolPercent;

                renderTreeLevels();
            } catch (error) {
                console.error("Error loading settings:", error);
                showAlert("Error loading settings", "error");
            }
        }

        function renderTreeLevels() {
            const container = document.getElementById("treeLevels");
            container.innerHTML = "";

            currentSettings.treeCommissionLevels.forEach((level, index) => {
                const div = document.createElement("div");
                div.className = "level-input";
                div.innerHTML = `
                    <label style="min-width: 80px;">Level ${level.level}:</label>
                    <input type="number" step="0.01" min="0" max="100" value="${level.percentage}" data-level="${index}">
                    <button class="btn btn-secondary" onclick="removeLevel(${index})" style="padding: 8px 16px;">Remove</button>
                `;
                container.appendChild(div);
            });
        }

        function addLevel() {
            const newLevel = currentSettings.treeCommissionLevels.length + 1;
            const lastPercentage = currentSettings.treeCommissionLevels[currentSettings.treeCommissionLevels.length - 1]?.percentage || 1.5;
            currentSettings.treeCommissionLevels.push({
                level: newLevel,
                percentage: lastPercentage / 2
            });
            renderTreeLevels();
        }

        function removeLevel(index) {
            currentSettings.treeCommissionLevels.splice(index, 1);
            currentSettings.treeCommissionLevels.forEach((level, i) => {
                level.level = i + 1;
            });
            renderTreeLevels();
        }

        async function saveSettings() {
            try {
                const treeLevels = [];
                document.querySelectorAll("#treeLevels input").forEach((input, index) => {
                    treeLevels.push({
                        level: index + 1,
                        percentage: parseFloat(input.value)
                    });
                });

                const settings = {
                    directCommissionPercent: parseFloat(document.getElementById("directCommission").value),
                    trustFundPercent: parseFloat(document.getElementById("trustFund").value),
                    developmentFundPercent: parseFloat(document.getElementById("devFund").value),
                    treeCommissionPoolPercent: parseFloat(document.getElementById("treePool").value),
                    treeCommissionLevels: treeLevels
                };

                const response = await fetch(`${API_URL}/admin/commission-settings`, {
                    method: 'PUT',
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(settings)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || "Failed to save settings");
                }

                showAlert("Settings saved successfully!", "success");
                loadSettings();
            } catch (error) {
                console.error("Error saving settings:", error);
                showAlert(error.message, "error");
            }
        }

        async function resetSettings() {
            if (!confirm("Are you sure you want to reset to default settings?")) return;

            try {
                const response = await fetch(`${API_URL}/admin/commission-settings/reset`, {
                    method: 'POST',
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (!response.ok) throw new Error("Failed to reset settings");

                showAlert("Settings reset to defaults!", "success");
                loadSettings();
            } catch (error) {
                console.error("Error resetting settings:", error);
                showAlert("Error resetting settings", "error");
            }
        }

        function showAlert(message, type) {
            const container = document.getElementById("alertContainer");
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => { container.innerHTML = ""; }, 5000);
        }

        loadSettings();
    </script>
</body>
</html>
